<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriGuard AI | Diagnostic Report</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #0a7a4b;
            --secondary: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --bg: #f4f7f6;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); margin: 0; padding: 40px 20px; display: flex; justify-content: center; }
        
        .report-card {
            max-width: 1000px; width: 100%; background: white; border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden;
        }
        
        /* Header Colors based on Risk */
        .header { padding: 40px; text-align: center; color: white; }
        .risk-Critical { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .risk-Warning { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .risk-Optimal { background: linear-gradient(135deg, #0a7a4b, #27ae60); }
        .risk-Healthy { background: linear-gradient(135deg, #0a7a4b, #27ae60); }

        .content { padding: 40px; }
        
        /* Quick Stats */
        .quick-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 30px; }
        .stat-item { background: #f8faf9; padding: 20px; border-radius: 12px; text-align: center; border-left: 4px solid var(--primary); }
        .stat-item h3 { margin: 0; font-size: 12px; color: #888; text-transform: uppercase; }
        .stat-item p { margin: 8px 0 0; font-size: 24px; font-weight: bold; color: var(--primary); }

        .image-section { text-align: center; margin-bottom: 30px; padding: 20px; background: #fff; border-radius: 15px; border: 2px dashed #ddd; }
        .image-section img { max-width: 300px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* Detailed Analysis Sections */
        .analysis-section { margin-bottom: 25px; }
        .analysis-box { 
            background: #fff8e1; border-left: 5px solid var(--warning); 
            padding: 25px; border-radius: 8px; margin-bottom: 20px; 
        }
        .action-plan { 
            background: #e8f5e9; border-left: 5px solid var(--primary); 
            padding: 25px; border-radius: 8px; margin-bottom: 20px; 
        }
        .disease-alert {
            background: #fdeaea; border-left: 5px solid var(--danger);
            padding: 25px; border-radius: 8px; margin-bottom: 20px;
        }
        
        .analysis-section h4 { 
            margin: 0 0 15px; color: var(--dark); 
            display: flex; align-items: center; gap: 10px;
        }
        
        /* AI Recommendations */
        .ai-recommendations {
            background: linear-gradient(135deg, #f8faf9, #fff);
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }
        .ai-recommendations h4 {
            color: var(--primary);
            margin: 0 0 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .recommendation-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .rec-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
        }
        .rec-item h5 { margin: 0 0 8px; color: var(--dark); font-size: 14px; }
        .rec-item p { margin: 0; font-size: 13px; color: #666; line-height: 1.5; }

        /* Soil & Weather Info */
        .env-info { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; 
        }
        .env-card {
            background: #f8faf9;
            padding: 20px;
            border-radius: 12px;
        }
        .env-card h5 { margin: 0 0 10px; color: var(--dark); }
        .env-card p { margin: 5px 0; font-size: 13px; color: #666; }
        
        .btn-group { margin-top: 30px; text-align: center; }
        .btn { padding: 12px 25px; border-radius: 30px; text-decoration: none; font-weight: bold; display: inline-block; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-print { border: 2px solid var(--primary); color: var(--primary); margin-left: 10px; }

        /* AI Chatbot */
        .chatbot-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(10, 122, 75, 0.4);
            z-index: 1000;
            transition: 0.3s;
        }
        .chatbot-btn:hover { transform: scale(1.1); }

        .chatbot-modal {
            display: none;
            position: fixed;
            bottom: 110px;
            right: 30px;
            width: 450px;
            height: 600px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            z-index: 1001;
            overflow: hidden;
        }
        .chatbot-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chatbot-header h3 { margin: 0; font-size: 18px; }
        .chatbot-close { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
        
        .chat-messages {
            height: 420px;
            padding: 20px;
            overflow-y: auto;
            background: #f8faf9;
        }
        .message { margin-bottom: 15px; padding: 15px; border-radius: 15px; max-width: 85%; }
        .message.ai { background: white; border: 1px solid #eee; border-radius: 15px 15px 15px 0; }
        .message.user { background: var(--primary); color: white; border-radius: 15px 15px 0 15px; margin-left: auto; }
        .message p { margin: 0; line-height: 1.6; font-size: 14px; }
        
        .chat-input {
            padding: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
        }
        .chat-input button {
            width: auto;
            padding: 12px 20px;
            border-radius: 25px;
        }

        .typing-indicator { display: none; padding: 15px; background: white; border: 1px solid #eee; border-radius: 15px 15px 15px 0; margin-bottom: 15px; }
        .typing-dots { display: flex; gap: 5px; }
        .typing-dots span { width: 8px; height: 8px; background: var(--primary); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="report-card">
    <div class="header risk-{{ risk }}">
        <i class="fa-solid fa-square-poll-vertical fa-3x"></i>
        <h1>Field Diagnostic Report</h1>
        <p>AI-Generated Analysis for your <strong>{{ crop_type }}</strong> crop</p>
    </div>

    <div class="content">
        {% if user_image %}
        <div class="image-section">
            <h3><i class="fa-solid fa-camera"></i> Analyzed Sample</h3>
            <img src="{{ user_image }}" alt="Crop Sample">
        </div>
        {% endif %}

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-item">
                <h3>Risk Level</h3>
                <p>{{ risk }}</p>
            </div>
            <div class="stat-item">
                <h3>Est. Loss</h3>
                <p>{{ loss }}</p>
            </div>
            <div class="stat-item">
                <h3>Crop</h3>
                <p>{{ crop_type }}</p>
            </div>
            <div class="stat-item">
                <h3>Status</h3>
                <p style="font-size: 18px;">{% if risk == 'Optimal' %}‚úÖ Healthy{% elif risk == 'Warning' %}‚ö†Ô∏è Monitor{% else %}üö® Alert{% endif %}</p>
            </div>
        </div>

        <!-- Environment Information -->
        <div class="env-info">
            <div class="env-card">
                <h5><i class="fa-solid fa-cloud-rain"></i> Environmental Conditions</h5>
                <p><strong>Analysis Date:</strong> {{ '' }}</p>
                <p><strong>Assessment Type:</strong> Multi-Factor Risk Analysis</p>
                <p><strong>AI Model:</strong> AgriGuard v2.0</p>
            </div>
            <div class="env-card">
                <h5><i class="fa-solid fa-clipboard-list"></i> Assessment Summary</h5>
                <p>Comprehensive analysis based on environmental parameters and disease probability models.</p>
            </div>
        </div>

        <!-- AI Analysis Breakdown -->
        <div class="analysis-box">
            <h4><i class="fa-solid fa-microscope"></i> üî¨ AI Analysis Breakdown</h4>
            <p><strong>System findings:</strong> {{ notes }}</p>
            <p style="margin-top:10px;"><strong>Disease Alert:</strong> {{ disease_alert }}</p>
        </div>

        <!-- Disease Alert (if any) -->
        {% if disease_alert != 'Clear' %}
        <div class="disease-alert">
            <h4><i class="fa-solid fa-triangle-exclamation"></i> üö® Disease Warning</h4>
            <p><strong>Alert Level:</strong> {{ 'HIGH' if disease_alert != 'Clear' else 'None' }}</p>
            <p><strong>Recommendation:</strong> Immediate action required. Monitor field closely and consider preventive spraying.</p>
        </div>
        {% endif %}

        <!-- Action Plan -->
        <div class="action-plan">
            <h4><i class="fa-solid fa-clipboard-check"></i> ‚úÖ Recommended Mitigation Strategy</h4>
            <p><strong>{{ action_plan }}</strong></p>
        </div>

        <!-- AI Recommendations -->
        <div class="ai-recommendations">
            <h4><i class="fa-solid fa-robot"></i> ü§ñ AI-Powered Additional Recommendations</h4>
            <div class="recommendation-grid">
                <div class="rec-item">
                    <h5>üå± Immediate Actions</h5>
                    <p>{% if risk == 'Critical' %}Apply emergency irrigation and bio-pesticides immediately. Consider consulting local agricultural extension officer.{% elif risk == 'Warning' %}Check for pest infestation and adjust fertilizer application.{% else %}Continue current practices. Consider preventive measures.{% endif %}</p>
                </div>
                <div class="rec-item">
                    <h5>üìÖ Follow-up Schedule</h5>
                    <p>{% if risk == 'Critical' %}Re-assess in 3-5 days after treatment.{% elif risk == 'Warning' %}Re-assess in 7-10 days.{% else %}Routine monitoring every 2 weeks.{% endif %}</p>
                </div>
                <div class="rec-item">
                    <h5>üß™ Nutrient Advisory</h5>
                    <p>{% if risk == 'Critical' %}Apply nitrogen-rich fertilizer after irrigation. Consider foliar application.{% elif risk == 'Warning' %}Maintain balanced NPK application.{% else %}Continue balanced nutrition schedule.{% endif %}</p>
                </div>
                <div class="rec-item">
                    <h5>üíß Water Management</h5>
                    <p>{% if risk == 'Critical' %}Ensure adequate irrigation. Avoid water stress.{% elif risk == 'Warning' %}Maintain consistent watering schedule.{% else %}Follow standard irrigation practices.{% endif %}</p>
                </div>
            </div>
        </div>

        <!-- Detailed Information Box -->
        <div style="background: #f8faf9; padding: 20px; border-radius: 12px; margin-bottom: 20px; border-left: 4px solid var(--secondary);">
            <h4 style="margin: 0 0 10px;"><i class="fa-solid fa-info-circle"></i> Understanding Your Report</h4>
            <p style="margin: 0; font-size: 13px; color: #666; line-height: 1.6;">
                This diagnostic report is generated using AgriGuard AI's multi-factor risk assessment engine. 
                The risk level is calculated based on environmental parameters (rainfall, temperature, humidity, soil pH) 
                specific to {{ crop_type }} crops. The AI provides actionable recommendations to help you 
                minimize crop loss and maximize yield. For personalized advice, consult with your local 
                agricultural extension officer or use the AI Assistant for more detailed queries.
            </p>
        </div>

        <div class="btn-group">
            <a href="/" class="btn btn-main"><i class="fa-solid fa-plus"></i> Run New Analysis</a>
            <a href="javascript:window.print()" class="btn btn-print"><i class="fa-solid fa-print"></i> Download PDF Report</a>
        </div>
    </div>
</div>

<!-- AI Chatbot Button -->
<button class="chatbot-btn" onclick="toggleChatbot()">
    <i class="fa-solid fa-robot"></i>
</button>

<!-- AI Chatbot Modal -->
<div class="chatbot-modal" id="chatbotModal">
    <div class="chatbot-header">
        <div>
            <h3><i class="fa-solid fa-robot"></i> AgriGuard AI Assistant</h3>
            <small>24/7 Farming Expert</small>
        </div>
        <button class="chatbot-close" onclick="toggleChatbot()">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="message ai">
            <p>üëã Namaste! Welcome to AgriGuard AI Assistant!</p>
            <p style="margin-top: 10px;">I can help you with detailed information about your {{ crop_type }} crop analysis:</p>
            <p style="margin-top: 10px;">
                üåæ <strong>Explain the report</strong> - Detailed breakdown of your results<br>
                ü¶† <strong>Disease information</strong> - About {{ disease_alert }}<br>
                üíß <strong>Water management</strong> - Irrigation tips<br>
                üß™ <strong>Fertilizer advice</strong> - Nutrient recommendations<br>
                üìä <strong>Yield optimization</strong> - Maximize your harvest
            </p>
            <p style="margin-top: 10px;">What would you like to know more about?</p>
        </div>
        <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    </div>
    <div class="chat-input">
        <input type="text" id="chatInput" placeholder="Ask me anything about farming..." onkeypress="handleChatKeyPress(event)">
        <button onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<script>
function toggleChatbot() {
    const modal = document.getElementById('chatbotModal');
    modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

function sendMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;

    addMessage(message, 'user');
    input.value = '';

    document.getElementById('typingIndicator').style.display = 'block';
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;

    fetch('/ai_chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            message: message,
            crop_type: '{{ crop_type }}'
        })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById('typingIndicator').style.display = 'none';
        if (data.status === 'success') {
            addMessage(data.response, 'ai');
        } else {
            addMessage('Sorry, I encountered an error. Please try again.', 'ai');
        }
    })
    .catch(err => {
        document.getElementById('typingIndicator').style.display = 'none';
        addMessage('Sorry, I encountered an error. Please try again.', 'ai');
    });
}

function addMessage(text, sender) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message ' + sender;
    messageDiv.innerHTML = '<p>' + text.replace(/\n/g, '<br>') + '</p>';
    chatMessages.insertBefore(messageDiv, document.getElementById('typingIndicator'));
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
</script>

</body>
</html>
